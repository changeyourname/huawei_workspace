/*
 * main.cpp
 *
 *  Created on: Oct 20, 2015
 *      Author: uzair
 */




#include <tlm>
#include <tlm_utils/simple_initiator_socket.h>
#include <stdio.h>
#include "cache.hpp"

class req_generator : public sc_core::sc_module {
public:
	tlm_utils::simple_initiator_socket<req_generator> m_isocket;

	SC_HAS_PROCESS(req_generator);
	req_generator(sc_core::sc_module_name name)
		:	m_isocket("m_isocket")
	{
		SC_THREAD(main);
	}

	void main() {
		while(1) {
			wait(10, sc_core::SC_NS);

			tlm::tlm_generic_payload trans;
			sc_core::sc_time delay = sc_core::SC_ZERO_TIME;
			trans.set_read();
			trans.set_address(0x107);
			trans.set_data_length(4);
			m_isocket->b_transport(trans, delay);

			unsigned char *ptr = trans.get_data_ptr();
			if (trans.get_command() == tlm::TLM_READ_COMMAND) {
				printf("data[0]=0x%02x | ", *ptr);
				printf("data[0]=0x%02x | ", *(ptr+1));
				printf("data[0]=0x%02x | ", *(ptr+2));
				printf("data[0]=0x%02x\r\n", *(ptr+3));
			}
		}
	}
};

int sc_main(int argc, char *argv[]) {
	req_generator m_req("m_req");
	cache m_cache("m_cache");

	m_req.m_isocket(m_cache.m_tsocket);

	sc_core::sc_start(100, sc_core::SC_NS);
	return 0;
}
